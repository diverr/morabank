var dataJSON = {};
dataJSON.chats = [{
    "id": 100,
    "client_id": 101,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "10-03-2016",
    "time": "09:",
    "messagesUnread": "2",
    "star": "1"
},
{
    "id": 101,
    "client_id": 101,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "18-03-2016",
    "time": "15:00 - 16:30",
    "messagesUnread": "1",
    "star": "0"
},
{
    "id": 102,
    "client_id": 102,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "11-03-2016",
    "time": "09:00",
    "messagesUnread": "3",
    "star": "0"
},
{
    "id": 103,
    "client_id": 103,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "18-03-2016",
    "time": "15:00 - 16:30",
    "messagesUnread": "3",
    "star": "0"
},
{
    "id": 104,
    "client_id": 104,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "19-03-2016",
    "time": "10:00 - 11:30",
    "messagesUnread": "0",
    "star": "1"
},
{
    "id": 105,
    "client_id": 105,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "11-03-2016",
    "time": "09:00 - 11:00",
    "messagesUnread": "2",
    "star": "0"
},
{
    "id": 106,
    "client_id": 106,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "10-03-2016",
    "time": "12:00 - 14:00",
    "messagesUnread": "0",
    "star": "1"
},
{
    "id": 107,
    "client_id": 107,
    "manager_id": 100,
    "lastMessage": "Tu: perfecto, nos pondremos en contacto para confirmar la cita",
    "date": "11-03-2016",
    "time": "09:00 - 11:00",
    "messagesUnread": "2",
    "star": "1"
}];

dataJSON.clients = [{
    "id": 100,
    "altamira": "234234",
    "photo": "img/a1.jpg",
    "name": "Carles",
    "lastName": "Fernández",
    "contact": "+376 600 123 000",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 101,
    "altamira": "333345",
    "photo": "img/a2.jpg",
    "name": "Jordi",
    "lastName": "García",
    "contact": "jgarcia74@hotmail.com",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 102,
    "altamira": "384545",
    "photo": "img/a3.jpg",
    "name": "Marta",
    "lastName": "Forcadell",
    "contact": "mlopez_s@hotmail.com",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 103,
    "altamira": "304857",
    "photo": "img/a4.jpg",
    "name": "Federico",
    "lastName": "Trillo",
    "contact": "+376 600 123 000",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 104,
    "altamira": "202398",
    "photo": "img/a5.jpg",
    "name": "Juan",
    "lastName": "García",
    "contact": "+376 660 822 143",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 105,
    "altamira": "348534",
    "photo": "img/a6.jpg",
    "name": "Mónica",
    "lastName": "Carpintero",
    "contact": "+376 600 123 000",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 106,
    "altamira": "034857",
    "photo": "img/a7.jpg",
    "name": "Gabriel",
    "lastName": "Ruiz",
    "contact": "jgarcia74@hotmail.com",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
},
{
    "id": 107,
    "altamira": "230982",
    "photo": "img/a8.jpg",
    "name": "Lucio",
    "lastName": "Camacho",
    "contact": "mlopez_s@hotmail.com",
    "contact_address": "Oficina 31 Avda Merritxell 35, Cafeteria Antonio, Calle Delicias 12 Madrid"
}];

dataJSON.managers = [{
    "id": 100,
    "photo": "img/a1.jpg",
    "name": "David Santiago"    
},
{
    "id": 101,
    "photo": "img/a2.jpg",
    "name": "Monica Smith"    
},
{
    "id": 102,
    "photo": "img/a3.jpg",
    "name": "Michael Smith"    
},
{
    "id": 103,
    "photo": "img/a4.jpg",
    "name": "Janet Smith"    
},
{
    "id": 104,
    "photo": "img/a5.jpg",
    "name": "Alice Smith"    
},
{
    "id": 105,
    "photo": "img/a6.jpg",
    "name": "Monica Cale"    
},
{
    "id": 106,
    "photo": "img/a7.jpg",
    "name": "Mark Jordan"    
},
{
    "id": 107,
    "photo": "img/a8.jpg",
    "name": "Janet Smith"    
}];

dataJSON.meetings = [{
    "id": 101,
    "client_id": 100,
    "manager_id": 100,
    "subject": "Contratación de fondo",
    "description": "Descripción de la cita.",
    "date": "11-02-2016",
    "time": "09:00 - 11:00",
    "location": "En la oficina"
},
{
    "id": 102,
    "client_id": 102,
    "manager_id": 100,
    "subject": "Firma de documentación",
    "description": "Descripción de la cita.",
    "date": "18-02-2016",
    "time": "15:00 - 16:30",
    "location": "En la oficina"
},
{
    "id": 103,
    "client_id": 103,
    "manager_id": 100,
    "subject": "Declaración de la renta",
    "description": "Descripción de la cita.",
    "date": "19-02-2016",
    "time": "10:00 - 11:30",
    "location": "En la oficina"
},
{
    "id": 104,
    "client_id": 104,
    "manager_id": 100,
    "subject": "Contratación de fondo",
    "description": "Descripción de la cita.",
    "date": "11-02-2016",
    "time": "09:00 - 11:00",
    "location": "En la oficina"
},
{
    "id": 105,
    "client_id": 105,
    "manager_id": 100,
    "subject": "Baja de cuenta",
    "description": "Descripción de la cita.",
    "date": "10-02-2016",
    "time": "12:00 - 14:00",
    "location": "En la oficina"
},
{
    "id": 106,
    "client_id": 106,
    "manager_id": 100,
    "subject": "Contratación de fondo",
    "description": "Descripción de la cita.",
    "date": "11-02-2016",
    "time": "09:00 - 11:00",
    "location": "En la oficina"
},
{
    "id": 107,
    "client_id": 107,
    "manager_id": 100,
    "subject": "Firma de documentación",
    "description": "Descripción de la cita.",
    "date": "18-02-2016",
    "time": "15:00 - 16:30",
    "location": "En la oficina"
},
{
    "id": 108,
    "client_id": 107,
    "manager_id": 100,
    "subject": "Declaración de la renta",
    "description": "Descripción de la cita.",
    "date": "19-02-2016",
    "time": "10:00 - 11:30",
    "location": "En la oficina"
},
{
    "id": 109,
    "client_id": 101,
    "manager_id": 100,
    "subject": "Contratación de fondo",
    "description": "Descripción de la cita.",
    "date": "11-02-2016",
    "time": "09:00 - 11:00",
    "location": "En la oficina"
}];

dataJSON.messages = [{
    "id": 100,
    "chat_id": 100,
    "is_manager": false,
    "date": "26/01/2016 09:30:31",
    "message": "Hola, me gustaría contratar una póliza"    
},
{
    "id": 101,
    "chat_id": 100,
    "is_manager": true,
    "date": "26/01/2016 09:35",
    "message": "Muy bien, ¿para que cuenta quiere asociar esta póliza?"
},
{
    "id": 102,
    "chat_id": 100,
    "is_manager": false,
    "date": "26/01/2016 09:30:37",
    "message": "Pues la quería para mi cuenta de ahorro que tengo allí en MoraBanc"    
},
{
    "id": 103,
    "chat_id": 100,
    "is_manager": true,
    "date": "26/01/2016 09:30:40",
    "message": "De acuerdo, no se retire"    
},

{
    "id": 100,
    "chat_id": 104,
    "is_manager": false,
    "date": "26/01/2016 09:30:31",
    "message": "Hola, me gustaría contratar una póliza"    
},
{
    "id": 101,
    "chat_id": 104,
    "is_manager": true,
    "date": "26/01/2016 09:35",
    "message": "Muy bien, ¿para que cuenta quiere asociar esta póliza?"
},
{
    "id": 102,
    "chat_id": 104,
    "is_manager": false,
    "date": "26/01/2016 09:30:37",
    "message": "Pues la quería para mi cuenta de ahorro que tengo allí en MoraBanc"    
},
{
    "id": 103,
    "chat_id": 104,
    "is_manager": true,
    "date": "26/01/2016 09:30:40",
    "message": "De acuerdo, no se retire"    
}];






angular.module('morabanc')
.service('Data', serviceData);

function serviceData($http) {

    var items = {};
    var refresh = false;
    var cookieName = "morabanc_refresh";
    
    function readJson(type, callback) {
        /*var url = 'js/app/data/' + type + '.json';

        $.get(url, function(data) {
            callback(data);
        });*/

        callback(dataJSON[type]);
    }

    function getId(type, callback) {
        getAll(type, function(items) {
            var id = 0;
            for(var i = 0; i < items.length; i++) {
                if(parseInt(items[i].id) > id) {
                    id = parseInt(items[i].id) + 1;
                }
            }
            callback(id);
        });
    }

    function save(type, data) {
        localStorage.setItem(type, JSON.stringify(data));
    }

    function getAll(type, callback) {
        
        var cookie = getCookie(cookieName);
        if(!cookie || cookie == null) {
            refresh = true;
            console.log("Refrescamos");
            // dejamos los datos en memoria por 10 minutos
            setCookie(cookieName, "1", 10);
        }

        // si mandamos a refrescar cogemos del archivo json
        if(refresh) {
            console.log("Reiniciamos los valores, los obtenemos del archivo json");
            localStorage.removeItem(type);
            readJson(type, function(data) {
                localStorage.setItem(type, JSON.stringify(data));
                items[type] = data;
                callback(data);
            })
        } else {
            
            if(items[type] && items[type] != null) {
                console.log("Coge del objeto en memoria");
                callback(items[type]);
            } else if(localStorage.getItem(type) && localStorage.getItem(type) != null) {
                console.log("Coge del objeto en localStorage");
                items[type] = JSON.parse(localStorage.getItem(type));
                callback(items[type]);
            } else {
                console.log("Coge los datos del archivo json");
                readJson(type, function(data) {
                    localStorage.setItem(type, JSON.stringify(data));
                    items[type] = data;
                    callback(data);
                })
            }

            
        }
    }

    function setCookie(cname, cvalue, min) {
        var d = new Date();
        d.setTime(d.getTime() + (min*60*1000));
        var expires = "expires="+d.toUTCString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1);
            if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
    }
    
    return {
        getAll: getAll,

        get: function(id, type, callback) {
            getAll(type, function(items) {
                for(var i = 0; i < items.length; i++) {
                    if(items[i].id == id) {
                        callback(items[i]);
                        return;
                    }
                }
            });
        }, 

        add : function(type, obj, callback) {
            getId(type, function(id) {
                obj.id = id;
                getAll(type, function(items) {
                    items.push(obj);
                    save(type, items);
                    callback(obj);
                });
            });
        },

        update: function(type, obj, callback) {
            getAll(type, function(items) {
                for(var i = 0; i < items.length; i++) {
                    if(items[i].id == obj.id) {
                        items[i] = obj;
                        save(type, items);
                        callback(obj);
                        return;
                    }
                }
            })
        }
    };

}